#!/usr/bin/env node

/* eslint-disable @typescript-eslint/no-require-imports */

/**
 * Uruchamia Lighthouse na wskazanym adresie (domyslnie http://localhost:3000).
 * Przyklad:
 *    node scripts/lighthouse-runner --url http://localhost:3000
 */

const fs = require("fs");
const path = require("path");
const lighthouseModule = require("lighthouse");
const chromeLauncher = require("chrome-launcher");
const lighthouse = lighthouseModule.default || lighthouseModule;

const projectRoot = path.join(__dirname, "..");
const args = process.argv.slice(2);
const urlFlagIndex = args.indexOf("--url");
const url =
  (urlFlagIndex !== -1 && args[urlFlagIndex + 1]) ||
  process.env.LH_URL ||
  "http://localhost:3000";

const reportsDir = path.join(projectRoot, "reports", "lighthouse");
fs.mkdirSync(reportsDir, { recursive: true });
const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
const outputPath = path.join(reportsDir, `lighthouse-${timestamp}.html`);

async function runLighthouse() {
  console.log(`-> Lighthouse dla ${url}`);
  const chrome = await chromeLauncher.launch({
    chromeFlags: ["--headless=new", "--no-sandbox", "--disable-dev-shm-usage"],
  });

  try {
    const runnerResult = await lighthouse(url, {
      port: chrome.port,
      output: "html",
      logLevel: "info",
    });

    const reportHtml = Array.isArray(runnerResult.report)
      ? runnerResult.report[0]
      : runnerResult.report;
    fs.writeFileSync(outputPath, reportHtml);
    console.log(`ok Raport zapisany: ${outputPath}`);
  } catch (error) {
    console.error("x Lighthouse zakonczyl sie bledem.", error);
    process.exit(1);
  } finally {
    try {
      await chrome.kill();
    } catch (cleanupError) {
      console.warn("! Ostrzezenie podczas zamykania Chrome:", cleanupError.message);
    }
  }
}

runLighthouse();
